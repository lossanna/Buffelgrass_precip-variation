---
title: "Code for linear models"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(dplyr)
library(ggplot2)
library(lme4)
library(glmmTMB)
library(DHARMa)
library(MuMIn)
library(performance)
library(modelbased)
load("../RData/publish_linear-models.RData")
```

Code to produce linear models presented in "Precipitation moderates associations between native shrubs and invasive buffelgrass (*Pennisetum ciliare*) growth in the Sonoran Desert while local topography has less influence" by Ossanna et al. (2026).

Contact: Lia Ossanna, lossanna@arizona.edu or lossanna@nmsu.edu  
Last updated: 2025-10-24  

Models:

1. Change in total buffelgrass culm count  
2. Change in reproductive buffelgrass culm count  
3. Change in buffelgrass plot density  
4. Change in buffelgrass plot cover  
5. Buffelgrass seedling survival  


# Setup
```{r Setup, eval=FALSE}
library(readr) # v2.1.5
library(dplyr) # v1.1.4
library(ggplot2) # v4.0.0
library(lme4) # v1.1-37
library(glmmTMB) # v1.1.13
library(DHARMa) # v0.4.7
library(MuMIn) # v1.48.11
library(performance) # v0.15.2
library(modelbased) # v0.13.0

# Load data ---------------------------------------------------------------

culm.change.raw <- read_csv("culm-data.csv")
plot.change.raw <- read_csv("plot-data.csv")
survival.dat.raw <- read_csv("survival-data.csv")

# Data wrangling ----------------------------------------------------------

# Center and scale numeric variables for each dataset
culm.change <- culm.change.raw %>% 
  mutate(PlotSlope_scaled = scale(PlotSlope, center = TRUE, scale = TRUE)[, 1],
         Prev_year_precip_scaled = scale(Prev_year_precip, center = TRUE, scale = TRUE)[, 1],
         Change_BGDensity_scaled = scale(Change_BGDensity, scale = TRUE)[, 1],
         Change_ShrubCover_scaled = scale(Change_ShrubCover, scale = TRUE)[, 1],
         Change_HerbCover_scaled = scale(Change_HerbCover, scale = TRUE)[, 1])

plot.change <- plot.change.raw %>% 
  mutate(PlotSlope_scaled = scale(PlotSlope, center = TRUE, scale = TRUE)[, 1],
         Prev_year_precip_scaled = scale(Prev_year_precip, center = TRUE, scale = TRUE)[, 1],
         Change_ShrubCover_scaled = scale(Change_ShrubCover, scale = TRUE)[, 1],
         Change_HerbCover_scaled = scale(Change_HerbCover, scale = TRUE)[, 1])

survival.dat <- survival.dat.raw %>% 
  mutate(Prev_year_precip_scaled = scale(Prev_year_precip, center = TRUE, scale = TRUE)[, 1],
         ShrubCover_scaled = scale(ShrubCover, center = TRUE, scale = TRUE)[, 1],
         HerbCover_scaled = scale(HerbCover, center = TRUE, scale = TRUE)[, 1],
         PlotSlope_scaled = scale(PlotSlope, center = TRUE, scale = TRUE)[, 1],
         BGDensity_scaled = scale(BGDensity, center = TRUE, scale = TRUE)[, 1])


# Transform 0s and 1s for survival data to accommodate beta regression
survival.dat <- survival.dat %>% 
  mutate(Survival_transf = pmin(pmax(Survival_perc, 1e-6), 1 - 1e-6))
```


# 1. Change in total culm count
## Construct global model and run model selection
```{r total, eval=FALSE}
# Global model via lme4
total <- lmer(Change_TotalCulms ~ Prev_year_precip_scaled +  
                Aspect + PlotSlope_scaled + Change_ShrubCover_scaled + Change_HerbCover_scaled +
                Change_BGDensity_scaled +
                Prev_year_precip_scaled * Change_BGDensity_scaled +
                Prev_year_precip_scaled * Change_ShrubCover_scaled +
                Prev_year_precip_scaled * Change_HerbCover_scaled +
                (1 | Transect),
              data = culm.change)

# Model selection via MuMIn
options(na.action = "na.fail")
total_set <- dredge(total) 
```

## Examine best model
```{r total best}
# Examine best model
total_best.model <- get.models(total_set, 1)[[1]]
summary(total_best.model)
res.total_best.model <- simulateResiduals(total_best.model) # residuals via DHARMa
plotQQunif(res.total_best.model)
plotResiduals(res.total_best.model)
```

## Examine top models
```{r total top}
# Examine models within 2 AICc units of best
total_top <- subset(total_set, delta <= 2)
rmarkdown::paged_table(total_top)

# Assign each top model to separate object
for (i in 1:nrow(total_top)) {
  assign(paste0("total_model", i), get.models(total_top, subset = i)[[1]])
} 

# R^2 of top models via performance
r2(total_model1) 
r2(total_model2)
```

## Model averaging
```{r total avg}
# Model averaging via MuMIn
total_avg <- model.avg(total_set, subset = delta <= 2)
summary(total_avg) # full average coefficients used for analysis
```

## Predicted vs. observed graph
```{r total pred}
# Predicted vs. observed graph of best model
total_pred <- estimate_expectation(total_best.model) # model predictions via modelbased
total_pred$Change_TotalCulms <- culm.change$Change_TotalCulms

total_pred %>% 
  ggplot(aes(x = Change_TotalCulms, y = Predicted)) +
  geom_point(alpha = 0.4) +
  geom_abline(slope = 1, intercept = 0, color = "blue", linewidth = 1) +
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "red") +
  geom_vline(xintercept = 0,
             linetype = "dashed",
             color = "red") +
  ggtitle("Total culm change model, predicted vs. observed (best model)") +
  xlab(expression(Delta ~ "Total live culms [observed]")) +
  theme_bw()
```



# 2. Change in reproductive culm count
## Construct global model and run model selection
```{r repro, eval=FALSE}
# Global model
repro <- lmer(Change_ReproductiveCulms ~ Prev_year_precip_scaled +  
                Aspect + PlotSlope_scaled + Change_ShrubCover_scaled + Change_HerbCover_scaled +
                Change_BGDensity_scaled +
                Prev_year_precip_scaled * Change_BGDensity_scaled +
                Prev_year_precip_scaled * Change_ShrubCover_scaled +
                Prev_year_precip_scaled * Change_HerbCover_scaled +
                (1 | Transect),
              data = culm.change)

# Model selection
options(na.action = "na.fail")
repro_set <- dredge(repro) 
```

## Examine best model
```{r repro best}
# Examine best model
repro_best.model <- get.models(repro_set, 1)[[1]]
summary(repro_best.model)
res.repro_best.model <- simulateResiduals(repro_best.model)
plotQQunif(res.repro_best.model)
plotResiduals(res.repro_best.model)
```

## Examine top models
```{r repro top}
# Examine models within 2 AICc units of best 
repro_top <- subset(repro_set, delta <= 2)
rmarkdown::paged_table(repro_top)

# Assign each top model to separate object
for (i in 1:nrow(repro_top)) {
  assign(paste0("repro_model", i), get.models(repro_top, subset = i)[[1]])
} 

# R^2 of top models
r2(repro_model1) 
r2(repro_model2)
r2(repro_model3) 
r2(repro_model4) 
r2(repro_model5)
```

## Model averaging
```{r repro avg}
# Model averaging of top models
repro_avg <- model.avg(repro_set, subset = delta <= 2)
summary(repro_avg)
```

## Predicted vs. observed graph
```{r repro pred}
# Predicted vs. observed graph of best model
repro_pred <- estimate_expectation(repro_best.model)
repro_pred$Change_ReproductiveCulms <- culm.change$Change_ReproductiveCulms

repro_pred %>% 
  ggplot(aes(x = Change_ReproductiveCulms, y = Predicted)) +
  geom_point(alpha = 0.4) +
  geom_abline(slope = 1, intercept = 0, color = "blue", linewidth = 1) +
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "red") +
  geom_vline(xintercept = 0,
             linetype = "dashed",
             color = "red") +
  ggtitle("Reproductive culm change model, predicted vs. observed (best model)") +
  xlab(expression(Delta ~ "Reproductive culms [observed]")) +
  theme_bw()
```



# 3. Change in plot density
## Construct global model and run model selection
```{r bgden, eval=FALSE}
# Global model
bgden <- lmer(Change_BGDensity ~ Prev_year_precip_scaled + 
                Aspect + PlotSlope_scaled + Change_ShrubCover_scaled +
                Change_HerbCover_scaled + 
                Prev_year_precip_scaled * Change_ShrubCover_scaled +
                Prev_year_precip_scaled * Change_HerbCover_scaled +
                (1 | Transect),
              data = plot.change)

# Model selection
options(na.action = "na.fail")
bgden_set <- dredge(bgden)
```

## Examine best model
```{r bgden best}
# Examine best model
bgden_best.model <- get.models(bgden_set, 1)[[1]]
summary(bgden_best.model)
res.bgden_best.model <- simulateResiduals(bgden_best.model)
plotQQunif(res.bgden_best.model)
plotResiduals(res.bgden_best.model) 
```

## Examine top models
```{r bgden top}
# Examine models within 2 AICc units of best 
bgden_top <- subset(bgden_set, delta <= 2)
rmarkdown::paged_table(bgden_top)

# Assign each top model to separate object
for (i in 1:nrow(bgden_top)) {
  assign(paste0("bgden_model", i), get.models(bgden_top, subset = i)[[1]])
} 

# R^2 of top models
r2(bgden_model1)
r2(bgden_model2) 
r2(bgden_model3)
r2(bgden_model4)
r2(bgden_model5)
```

## Model averaging
```{r bgden avg}
# Model averaging of top models
bgden_avg <- model.avg(bgden_set, subset = delta <= 2)
summary(bgden_avg)
```

## Predicted vs. observed graph
```{r bgden pred}
# Predicted vs. observed graph of best model
bgden_pred <- estimate_expectation(bgden_best.model)
bgden_pred$Change_BGDensity <- plot.change$Change_BGDensity

bgden_pred %>% 
  ggplot(aes(x = Change_BGDensity, y = Predicted)) +
  geom_point(alpha = 0.4) +
  geom_abline(slope = 1, intercept = 0, color = "blue", linewidth = 1) +
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "red") +
  geom_vline(xintercept = 0,
             linetype = "dashed",
             color = "red") +
  ggtitle("Plot density change model, predicted vs. observed (best model)") +
  xlab(expression(Delta ~ paste("Buffelgrass density (individuals / ", m^2, ") [observed]"))) +
  theme_bw()
```



# 4. Change in plot cover
## Construct global model and run model selection
```{r bgcov, eval=FALSE}
# Global model
bgcov <- lmer(Change_BGCover ~ Prev_year_precip_scaled + 
                Aspect + PlotSlope_scaled + Change_ShrubCover_scaled +
                Change_HerbCover_scaled + 
                Prev_year_precip_scaled * Change_ShrubCover_scaled +
                Prev_year_precip_scaled * Change_HerbCover_scaled +
                (1 | Transect),
              data = plot.change)

# Model selection
options(na.action = "na.fail")
bgcov_set <- dredge(bgcov) # some models had trouble with random effects; got warning: boundary (singular) fit: see help('isSingular')
```
- Some models had trouble with random effects; got the following warning: ` boundary (singular) fit: see help('isSingular')`.

## Examine best model
```{r bgcov best}
# Examine best model
bgcov_best.model <- get.models(bgcov_set, 1)[[1]]
summary(bgcov_best.model)
res.bgcov_best.model <- simulateResiduals(bgcov_best.model)
plotQQunif(res.bgcov_best.model)
plotResiduals(res.bgcov_best.model)
```

## Examine top models
- Additional check for singularity issue among top models; found no issues.
```{r bgcov top}
# Examine models within 2 AICc units of best 
bgcov_top <- subset(bgcov_set, delta <= 2)
rmarkdown::paged_table(bgcov_top)

# Assign each top model to separate object
for (i in 1:nrow(bgcov_top)) {
  assign(paste0("bgcov_model", i), get.models(bgcov_top, subset = i)[[1]])
} 

# Check singularity of top models
bgcov_top.models <- get.models(bgcov_set, subset = delta <= 2)
lapply(bgcov_top.models, isSingular) # no top models have issues (all returned FALSE)

# R^2 of top models
r2(bgcov_model1)
r2(bgcov_model2) 
r2(bgcov_model3) 
r2(bgcov_model4) 
r2(bgcov_model5) 
r2(bgcov_model6) 
```

## Model averaging
```{r bgcov avg}
# Model averaging of top models
bgcov_avg <- model.avg(bgcov_set, subset = delta <= 2)
summary(bgcov_avg)
```

## Predicted vs. observed graph
```{r bgcov pred}
# Predicted vs. observed graph of best model
bgcov_pred <- estimate_expectation(bgcov_best.model)
bgcov_pred$Change_BGCover <- plot.change$Change_BGCover

bgcov_pred %>% 
  ggplot(aes(x = Change_BGCover, y = Predicted)) +
  geom_point(alpha = 0.4) +
  geom_abline(slope = 1, intercept = 0, color = "blue", linewidth = 1) +
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "red") +
  geom_vline(xintercept = 0,
             linetype = "dashed",
             color = "red") +
  ggtitle("Plot cover change model, predicted vs. observed (best model)") +
  xlab(expression(Delta ~ "Buffelgrass cover (%) [observed]")) +
  theme_bw()
```



# 5. Seedling survival
## Construct global model and run model selection
```{r survival, eval=FALSE}
# Global model
survival <- glmmTMB(Survival_transf ~ Prev_year_precip_scaled +
                      Aspect + PlotSlope_scaled + ShrubCover_scaled +
                      HerbCover_scaled + BGDensity_scaled +
                      Prev_year_precip_scaled * ShrubCover_scaled +
                      Prev_year_precip_scaled * HerbCover_scaled +
                      Prev_year_precip_scaled * BGDensity_scaled +
                      (1 | Transect),
                    data = survival.dat,
                    family = beta_family(link = "logit"))

# Model selection
options(na.action = "na.fail")
survival_set <- dredge(survival) 
```

## Examine best model
```{r survival best}
# Examine best model
survival_best.model <- get.models(survival_set, 1)[[1]]
summary(survival_best.model)
res.survival_best.model <- simulateResiduals(survival_best.model)
plotQQunif(res.survival_best.model)
plotResiduals(res.survival_best.model)
```

## Examine top models
```{r}
# Examine models within 2 AICc units of best 
survival_top <- subset(survival_set, delta <= 2)
rmarkdown::paged_table(survival_top)

# Assign each top model to separate object
for (i in 1:nrow(survival_top)) {
  assign(paste0("survival_model", i), get.models(survival_top, subset = i)[[1]])
} 

# R^2 of top models
r2(survival_model1) 
r2(survival_model2) 
r2(survival_model3) 
r2(survival_model4) 
r2(survival_model5) 
r2(survival_model6) 
r2(survival_model7) 
r2(survival_model8) 
r2(survival_model9) 
r2(survival_model10)
r2(survival_model11)
r2(survival_model12) 
r2(survival_model13) 
r2(survival_model14) 
r2(survival_model15) 
```

## Model averaging
```{r survival avg}
# Model averaging of top models
survival_avg <- model.avg(survival_set, subset = delta <= 2)
summary(survival_avg)
```

## Predicted vs. observed graph
```{r}
# Predicted vs. observed graph of best model
survival_pred <- estimate_expectation(survival_best.model)
survival_pred$Survival_transf <- survival.dat$Survival_transf

survival_pred %>% 
  ggplot(aes(x = Survival_transf, y = Predicted)) +
  geom_point(alpha = 0.4) +
  geom_abline(slope = 1, intercept = 0, color = "blue", linewidth = 1) +
  ggtitle("Seedling survival model, predicted vs. observed (best model)")  +
  xlab("Buffelgrass seedling survival (%) [observed]") +
  theme_bw() +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent)
```

